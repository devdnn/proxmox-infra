---
- name: Configure all proxmox guests
  hosts: proxmox_client
  become: yes

  tasks:
    - name: Update and upgrade all packages to the latest version
      ansible.builtin.apt:
        update_cache: true
        upgrade: 'yes'

    - name: Install qemu-guest-agent and register if installed
      apt:
        name: qemu-guest-agent
        state: present
        update_cache: true
      register: qemu_guest_agent

    - name: Start qemu-guest-agent
      service:
        name: qemu-guest-agent
        state: started
        enabled: yes
      when: qemu_guest_agent.changed
